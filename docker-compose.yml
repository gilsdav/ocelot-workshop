version: "3.7"
services:
  db:
    container_name: PizzaGraphSQL
    image: exoplatform/sqlserver:2017-CU8
    environment:
      - SA_PASSWORD=PizzaGraphQL123+
      - SQLSERVER_DATABASE=PizzaGraphQL
      - SQLSERVER_USER=PizzaGraphQL
      - SQLSERVER_PASSWORD=PizzaGraphQL123+
    ports:
      - "1433:1433"
    networks: 
      - private
    # healthcheck:
    #   test: /opt/mssql-tools/bin/sqlcmd -S localhost -U "$$SQLSERVER_USER" -P "$$SQLSERVER_PASSWORD" -Q "SELECT name FROM master.sys.databases WHERE name = N'$$SQLSERVER_DATABASE'" || exit 1
    #   interval: 10s
    #   timeout: 3s
    #   retries: 10
    #   start_period: 10s
  pizza-management:
    build: ./services/pizza-management
    image: pizza-management:latest
    ports:
      - "8080:80"
    networks: 
      - private
    depends_on:
      - db
  pizza-commands:
    build: ./services/pizza-commands
    image: pizza-commands:latest
    ports:
      - "8081:80"
    depends_on:
      - db
    networks: 
      - private
  pizza-pricing:
    build: ./services/pizza-pricing
    image: pizza-pricing:latest
    ports:
      - "8082:80"
    networks: 
      - private
    depends_on:
      - db
  identity-server:
    build: ./identity-server
    image: identity-server:latest
    ports:
      - "8090:80"
    networks: 
      - private
  public_gateway:
    build: './api-gateway/gateway'
    image: public_gateway:latest
    ports:
      - "8091:80"
    networks: 
      - public
      - private
    volumes: 
      - ./api-gateway/config/public.ocelot.json:/app/ocelot.json
  private_gateway:
    build: './api-gateway/gateway'
    image: private_gateway:latest
    ports:
      - "8092:80"
    networks: 
      - local
      - private
    volumes: 
      - ./api-gateway/config/private.ocelot.json:/app/ocelot.json
networks:
  public: {}
  local: {}
  private:
    internal: true